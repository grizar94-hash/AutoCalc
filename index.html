<!DOCTYPE html>
<html lang="ru" data-theme="system">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Калькулятор авто из Кореи</title>

<link rel="icon" href="icon.png" type="image/png" />
<link rel="apple-touch-icon" href="icon.png" />
<link rel="manifest" href="manifest.json" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
  :root{
    --accent:#0a66c2;
    --bg:#f5f6f8;
    --panel:#ffffff;
    --text:#1a1a1a;
    --muted:#6b7280;
    --border:#e5e7eb;
    --radius:10px;
    --shadow:0 2px 6px rgba(0,0,0,.06);
    --btn:#e5e7eb; --btn-text:#1a1a1a; --btn-hover:#d4d6db;
  }
  [data-theme="dark"]{
    --bg:#0e1116; --panel:#12161d; --text:#e5e7eb; --muted:#9aa3af; --border:#232833; --shadow:none;
    --btn:#2a2f3a; --btn-text:#e5e7eb; --btn-hover:#3a4150;
  }

  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    font-family:'Inter','Roboto','Segoe UI',Arial,sans-serif;
    background:var(--bg); color:var(--text);
    margin:0; padding:20px; position:relative;
  }

  /* Переключаемый фон BMW */
  body::before{
    content:""; position:fixed; inset:0; pointer-events:none;
    opacity:.06; filter:grayscale(100%);
    background-size:cover; background-position:center; background-attachment:fixed;
    display:none;
  }
  body.bg-bmw::before{ display:block; background-image:url('bg_bmw.jpg'); }

  .wrap{ max-width:820px; margin:0 auto; position:relative; z-index:1; }
  header{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:16px; flex-wrap:wrap; }
  h1{ font-size:20px; margin:0; color:var(--accent); font-weight:700; }

  .switchers{ display:flex; gap:10px; flex-wrap:wrap; }
  .switchers .group{ display:flex; gap:6px; align-items:center; font-size:12px; color:var(--muted); }
  .switchers select{
    padding:8px 10px; border:1px solid var(--border); border-radius:8px; background:var(--panel); color:var(--text);
  }

  .section{
    background:var(--panel); border:1px solid var(--border);
    border-radius:var(--radius); padding:20px; margin-bottom:20px;
    box-shadow:var(--shadow);
  }
  .section h3{ margin:0 0 12px; font-size:18px; font-weight:600; }

  label{ display:block; margin-top:12px; font-weight:500; font-size:14px; }
  input, select{
    width:100%; padding:10px 12px;
    border:1px solid var(--border); border-radius:var(--radius);
    font-size:15px; margin-top:6px; background:var(--panel); color:var(--text);
  }
  input:focus, select:focus{ outline:none; border-color:var(--accent); box-shadow:0 0 0 1px var(--accent); }

  .row{ display:flex; gap:14px; flex-wrap:wrap; }
  .row>div{ flex:1 1 220px; }

  .subpanel{
    margin-top:14px; border:1px solid var(--border); border-radius:var(--radius);
    padding:14px; background:color-mix(in hsl, var(--panel), transparent 0%);
  }
  .subpanel h4{ margin:0 0 10px; font-size:15px; font-weight:600; }
  .grid{ display:grid; grid-template-columns:1fr auto; gap:8px 10px; align-items:center }
  .note{ font-size:12px; color:var(--muted); margin-top:4px }
  .muted{ color:var(--muted); font-size:13px }

  /* pill-радио */
  .radio-line{ display:flex; gap:10px; flex-wrap:wrap; margin-top:6px }
  .radio-line label{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px; border:1px solid var(--border); border-radius:999px;
    font-size:14px; cursor:pointer; background:var(--panel); white-space:nowrap;
    transition:background .15s,border-color .15s, box-shadow .15s;
  }
  .radio-line input{ appearance:none; width:14px; height:14px; border-radius:50%; border:2px solid var(--muted); display:inline-block; position:relative; }
  .radio-line input:checked{ border-color:#3b82f6; box-shadow:inset 0 0 0 3px var(--panel), 0 0 0 3px #3b82f6; }
  .radio-line input:focus-visible{ outline:2px solid var(--accent); }

  /* кнопки — серые */
  button, .toggle-btn{
    width:100%; padding:14px; margin-top:14px;
    font-size:16px; font-weight:600;
    border:none; border-radius:var(--radius);
    cursor:pointer; background:var(--btn); color:var(--btn-text);
    transition:.2s; box-shadow:var(--shadow);
  }
  button:hover{ background:var(--btn-hover) }

  .result{
    margin-top:20px; padding:20px;
    background:var(--panel); border:1px solid var(--border);
    border-radius:var(--radius); font-size:16px;
    box-shadow:var(--shadow);
  }
  .result p{ margin:10px 0; font-weight:600 }
  hr{ border:0; border-top:1px solid var(--border); margin:12px 0 }
  .auto-output{ background:var(--panel) }
</style>
</head>
<body>
<main class="wrap">
  <header>
    <h1>Калькулятор доставки авто из Кореи</h1>
    <div class="switchers">
      <div class="group">
        Тема:
        <select id="themeSelect" aria-label="Переключатель темы">
          <option value="system" selected>Система</option>
          <option value="light">Светлая</option>
          <option value="dark">Тёмная</option>
        </select>
      </div>
      <div class="group">
        Фон:
        <select id="bgSelect" aria-label="Переключатель фона">
          <option value="off" selected>Выкл</option>
          <option value="bmw">BMW</option>
        </select>
      </div>
    </div>
  </header>

  <!-- КУРСЫ -->
  <div class="section" id="blockCurrency">
    <h3>Курсы валют</h3>
    <div class="row">
      <div>
        <label>USDT → ₽:
          <input type="text" inputmode="decimal" id="rubUsdt" placeholder="введите или авто">
        </label>
        <div class="note" id="usdtSrc">Источник: —</div>
      </div>
      <div>
        <label>USDT → ₩:
          <input type="text" inputmode="decimal" id="usdtKrw" placeholder="введите или авто">
        </label>
        <div class="note" id="usdtSrc2">Источник: —</div>
      </div>
    </div>
    <div class="subpanel">
      <div class="grid">
        <div class="muted">Курс EUR → ₽ (ЦБ)</div>
        <input class="auto-output" id="eurRub" placeholder="авто" readonly>
        <div class="muted">Курс KRW → ₽ (ЦБ)</div>
        <input class="auto-output" id="krwRub" placeholder="авто" readonly>
      </div>
      <div class="note" id="cbrSrc">Курсы ЦБ РФ на —</div>
    </div>
  </div>

  <!-- КОРЕЯ -->
  <div class="section" id="blockKorea">
    <h3>Корея</h3>
    <label>Цена авто (₩): <input type="text" inputmode="numeric" id="priceKrw" placeholder="например 20 000 000"></label>
    <label>Расходы в Корее включая фрахт (₩): <input type="text" inputmode="numeric" id="expensesKrw" placeholder="например 1 000 000"></label>
  </div>

  <!-- РОССИЯ -->
  <div class="section" id="blockRussia">
    <h3>Россия</h3>

    <div class="subpanel" id="autoCustoms">
      <h4>Авторасчёт пошлины и сборов</h4>

      <div class="row">
        <div>
          <div class="muted">Тип ввозящего</div>
          <div class="radio-line">
            <label><input type="radio" name="importer" value="individual" checked> <span>Физлицо</span></label>
            <label><input type="radio" name="importer" value="business"> <span>Юрлицо / ИП</span></label>
          </div>
        </div>
        <div>
          <div class="muted">Тип двигателя</div>
          <div class="radio-line">
            <label><input type="radio" name="eng" value="ice" checked> <span>ДВС</span></label>
            <label><input type="radio" name="eng" value="ev"> <span>Электро</span></label>
          </div>
        </div>
      </div>

      <div class="row" id="paramsICE">
        <div>
          <label>Объём двигателя (см³): <input type="text" inputmode="numeric" id="engineCc" placeholder="например 1 998"></label>
        </div>
        <div>
          <div class="muted">Возраст</div>
          <div class="radio-line">
            <label><input type="radio" name="age" value="<3"> <span>Младше 3</span></label>
            <label><input type="radio" name="age" value="3-5" checked> <span>3–5</span></label>
            <label><input type="radio" name="age" value=">5"> <span>Старше 5</span></label>
          </div>
        </div>
      </div>

      <div class="row" id="paramsEV" style="display:none">
        <div><label>Мощность (кВт): <input type="text" inputmode="numeric" id="motorKw" placeholder="например 150"></label></div>
        <div>
          <div class="muted">Возраст</div>
          <div class="radio-line">
            <label><input type="radio" name="age_ev" value="<3" checked> <span>Младше 3</span></label>
            <label><input type="radio" name="age_ev" value=">=3"> <span>3 и старше</span></label>
          </div>
        </div>
      </div>

      <!-- скрытая ТС -->
      <input type="hidden" id="__tsRubHidden">

      <div class="subpanel">
        <div class="grid">
          <div>Цена авто с пошлиной и сборами (₽)</div>
          <input class="auto-output" id="priceWithDutyRub" readonly>
        </div>
      </div>

      <div class="subpanel">
        <div class="grid">
          <div>Пошлина (₽)</div>                              <input class="auto-output" id="autoDuty" readonly>
          <div>Таможенный сбор (₽)</div>                      <input class="auto-output" id="autoCustomsFee" readonly>
          <div>Утилизационный сбор (₽)</div>                  <input class="auto-output" id="autoUtil" readonly>
          <div><strong>Итого «Пошлина и сборы» (₽)</strong></div> <input class="auto-output" id="autoTotalCustoms" readonly>
        </div>
      </div>
    </div>

    <label>Таможенное оформление и услуги брокера (₽): <input type="text" inputmode="numeric" id="brokerRub" placeholder="например 70 000"></label>
    <label>Доставка по России (₽): <input type="text" inputmode="numeric" id="deliveryRub" placeholder="например 50 000"></label>
  </div>

  <!-- Страховка -->
  <button id="insuranceBtn" type="button" class="toggle-btn">Страховка 0,3%: выкл</button>
  <input type="checkbox" id="insuranceCheck" hidden>

  <!-- Действия -->
  <button id="calcBtn">Рассчитать</button>
  <button class="clear" id="clearBtn">Очистить поля</button>

  <div class="result" id="result"></div>

  <button class="pdf" id="pdfBtn">Скачать PDF-отчёт</button>
</main>

<script>
/* ===== шкалы ===== */
const DUTY_INDIV = {
  "<3":[
    {min:0,max:1000,adval:0.48,spec:3.5},{min:1000,max:1500,adval:0.48,spec:3.5},
    {min:1500,max:1800,adval:0.48,spec:3.5},{min:1800,max:2000,adval:0.48,spec:3.5},
    {min:2000,max:3000,adval:0.15,spec:2.5},{min:3000,max:3500,adval:0.15,spec:2.7},{min:3500,max:1e9,adval:0.20,spec:3.0}
  ],
  "3-5":[
    {min:0,max:1000,adval:null,spec:1.5},{min:1000,max:1500,adval:null,spec:1.7},
    {min:1500,max:1800,adval:null,spec:2.5},{min:1800,max:2300,adval:null,spec:2.7},
    {min:2300,max:3000,adval:null,spec:3.0},{min:3000,max:3500,adval:null,spec:3.6},{min:3500,max:1e9,adval:null,spec:5.7}
  ],
  ">5":[
    {min:0,max:1000,adval:null,spec:3.0},{min:1000,max:1500,adval:null,spec:3.2},
    {min:1500,max:1800,adval:null,spec:3.5},{min:1800,max:2300,adval:null,spec:4.8},
    {min:2300,max:3000,adval:null,spec:5.0},{min:3000,max:3500,adval:null,spec:5.7},{min:3500,max:1e9,adval:null,spec:7.5}
  ]
};
const DUTY_BIZ = DUTY_INDIV;

/* Таможенный сбор — ПО ЦЕНЕ В KRW */
const CUSTOMS_FEE = [
  { max: 3_500_000,  fee: 1067 },
  { max: 7_500_000,  fee: 2134 },
  { max: 20_000_000, fee: 4269 },
  { max: 44_500_000, fee: 11746 },
  { max: 69_500_000, fee: 16524 },
  { max: 91_000_000, fee: 21344 },
  { max: 116_000_000, fee: 27540 },
  { max: 1e12,       fee: 30000 }
];

/* ===== helpers ===== */
const $=id=>document.getElementById(id);
const onlyDigits = v => String(v??'').replace(/\D/g,'');
const toNumber = v => (parseFloat(String(v??'').replace(/\s/g,'').replace(',', '.')))||0;
const fmtSpaces = (n, frac=0)=>{
  if(!isFinite(n)) return '';
  const opts={useGrouping:true, minimumFractionDigits:frac, maximumFractionDigits:frac};
  return Number(n).toLocaleString('ru-RU', opts).replace(/\u00A0/g,' ');
};

/* живые пробелы */
function liveIntegerSpaces(el){
  el.addEventListener('input', ()=>{
    const digits = onlyDigits(el.value);
    el.value = digits ? fmtSpaces(digits) : '';
  });
  el.addEventListener('focus', ()=> el.setSelectionRange(el.value.length, el.value.length));
}

/* таблицы пошлины */
function pickRow(tbl,age,cc){ return tbl[age].find(r=>cc>r.min && cc<=r.max); }
function dutyICE({table,age,cc,ts,eurRub}){
  const r=pickRow(table,age,cc);
  const ad = r.adval ? ts * r.adval : 0;           // % от ТС (в ₽)
  const sp = r.spec ? cc * r.spec * eurRub : 0;    // €/см³ × курс EUR→₽
  return Math.max(ad, sp);
}
function dutyEV(ts){ return ts*0.15; }

/* таможенный сбор по KRW */
function customsFeeKRW(totalKrw){ return CUSTOMS_FEE.find(b=>totalKrw<=b.max).fee; }

/* утиль */
function utilFee({importer,isEV,age,cc,kw}){
  if (importer==='individual') return (age === '<3') ? 3400 : 5200;
  // бизнес (приближённо, как обсуждали)
  const base=(age==='<3')?200000:150000;
  const k = isEV ? (kw<=85?0.17:0.26)
                 : (cc<=1000?0.17:(cc<=2000?0.34:(cc<=3000?0.43:(cc<=3500?0.86:1.34))));
  return Math.round(base*k);
}

/* ===== курсы ===== */
async function fetchCbr(){
  try{
    const r = await fetch('https://www.cbr-xml-daily.ru/daily_json.js',{cache:'no-store'});
    const d = await r.json();
    const EUR = d.Valute.EUR.Value / d.Valute.EUR.Nominal;
    const KRW = d.Valute.KRW.Value / d.Valute.KRW.Nominal;
    $('eurRub').value = fmtSpaces(EUR,6);
    $('krwRub').value = fmtSpaces(KRW,6);
    $('cbrSrc').textContent = `Курсы ЦБ РФ на ${new Date(d.Date).toLocaleDateString('ru-RU')}`;
  }catch(e){ $('cbrSrc').textContent='Курсы ЦБ РФ: ошибка загрузки'; }
}
async function fetchUsdt(){
  try{
    const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=tether&vs_currencies=rub,krw',{cache:'no-store'});
    const j = await r.json();
    $('rubUsdt').value = fmtSpaces(Number(j.tether.rub),4);
    $('usdtKrw').value = fmtSpaces(Number(j.tether.krw),2);
    const now=new Date().toLocaleString('ru-RU');
    $('usdtSrc').textContent=`Источник: CoinGecko • ${now}`;
    $('usdtSrc2').textContent=`Источник: CoinGecko • ${now}`;
  }catch(e){ $('usdtSrc').textContent='Источник: ошибка загрузки'; $('usdtSrc2').textContent='Источник: ошибка загрузки'; }
}

/* ===== переключатели ===== */
function engineType(){ return document.querySelector('input[name="eng"]:checked').value; }
function importer(){ return document.querySelector('input[name="importer"]:checked').value; }
function ageRaw(){
  return engineType()==='ev'
    ? document.querySelector('input[name="age_ev"]:checked').value
    : document.querySelector('input[name="age"]:checked').value;
}
function toggleEV(){
  const ev = engineType()==='ev';
  $('paramsICE').style.display = ev ? 'none' : 'flex';
  $('paramsEV').style.display  = ev ? 'flex' : 'none';
}

/* ===== пересчёт пошлин ===== */
function recompute(){
  const eur = toNumber($('eurRub').value);
  const krw = toNumber($('krwRub').value);

  const priceKrw = toNumber($('priceKrw').value);
  const expKrw   = toNumber($('expensesKrw').value);
  const totalKrw = priceKrw + expKrw;

  const tsRub = totalKrw * krw;  // таможенная стоимость в ₽
  $('__tsRubHidden').value = Math.round(tsRub);

  const imp=importer(), isEV=(engineType()==='ev'), age=ageRaw();

  let duty=0, util=0;
  if(isEV){
    duty = dutyEV(tsRub);
    const kw = toNumber($('motorKw').value);
    util = utilFee({importer:imp,isEV:true,age,kw});
  }else{
    const cc = toNumber($('engineCc').value);
    const table=(imp==='business')?DUTY_BIZ:DUTY_INDIV;
    duty = dutyICE({table,age,cc,ts:tsRub,eurRub:eur});
    util = utilFee({importer:imp,isEV:false,age,cc});
  }

  const fee = customsFeeKRW(totalKrw); // <— ВАЖНО: по KRW!
  const totalCustoms = Math.round(duty + fee + util);

  $('autoDuty').value = fmtSpaces(Math.round(duty));
  $('autoCustomsFee').value = fmtSpaces(fee);
  $('autoUtil').value = fmtSpaces(util);
  $('autoTotalCustoms').value = fmtSpaces(totalCustoms);

  const carPriceRub = priceKrw * krw; // только цена авто
  $('priceWithDutyRub').value = fmtSpaces(Math.round(carPriceRub + totalCustoms));
}

/* ===== основной расчёт ===== */
function calculate(){
  const rubUsdt = toNumber($('rubUsdt').value);
  const usdtKrw = toNumber($('usdtKrw').value);

  const priceKrw = toNumber($('priceKrw').value);
  const expKrw   = toNumber($('expensesKrw').value);
  const autoTotal = toNumber($('autoTotalCustoms').value);
  const broker = toNumber($('brokerRub').value);
  const delivery = toNumber($('deliveryRub').value);
  const insuranceOn = $('insuranceCheck').checked;

  const koreaKrw = priceKrw + expKrw;
  const rubNeeded = usdtKrw ? (koreaKrw / usdtKrw) * rubUsdt : 0;
  const russiaSubtotal = autoTotal + broker + delivery;
  const preFinal = rubNeeded + russiaSubtotal;
  const insurance = insuranceOn ? preFinal * 0.003 : 0;
  const finalRub = preFinal + insurance;

  $('result').innerHTML = `
    <p>В Корее: ${fmtSpaces(Math.round(rubNeeded))} ₽</p>
    <p>В России: ${fmtSpaces(Math.round(russiaSubtotal))} ₽</p>
    ${insuranceOn ? `<p>Страховка: ${fmtSpaces(Math.round(insurance))} ₽</p>` : ''}
    <hr><p>Под ключ: <strong>${fmtSpaces(Math.round(finalRub))} ₽</strong></p>`;
}

/* ===== PDF ===== */
function fmt(n,d=0){ if(!isFinite(n)) return '—'; const v=d?Number(n).toFixed(d):Math.round(n); return fmtSpaces(Number(v), d); }
async function downloadPDF(){
  try{
    const val = id => toNumber($(id)?.value);
    const insuranceOn = $('insuranceCheck').checked;

    const priceKrw    = val('priceKrw');
    const expensesKrw = val('expensesKrw');
    const rubUsdt     = val('rubUsdt');
    const usdtKrw     = val('usdtKrw');
    const eurRub      = val('eurRub');
    const krwRub      = val('krwRub');

    const autoDuty    = val('autoDuty');
    const autoCustomsFee = val('autoCustomsFee');
    const autoUtil    = val('autoUtil');
    const autoTotal   = val('autoTotalCustoms');
    const priceWithDutyRub = val('priceWithDutyRub');

    const brokerRub   = val('brokerRub');
    const deliveryRub = val('deliveryRub');

    const koreaKrw        = priceKrw + expensesKrw;
    const rubNeeded       = usdtKrw ? (koreaKrw / usdtKrw) * rubUsdt : 0;
    const russiaSubtotal  = autoTotal + brokerRub + deliveryRub;
    const preFinal        = rubNeeded + russiaSubtotal;
    const insuranceRub    = insuranceOn ? preFinal * 0.003 : 0;
    const finalRub        = preFinal + insuranceRub;

    const page = document.createElement('div');
    page.style.cssText = `
      position:fixed; left:-99999px; top:0; width:794px; background:#fff; color:#000;
      font-family:-apple-system, system-ui, Segoe UI, Inter, Roboto, Arial, sans-serif;
    `;
    const add = html => { const d=document.createElement('div'); d.innerHTML=html; page.appendChild(d); };

    add('<div style="height:8px;background:#111;width:100%"></div>');

    let logoSrc='';
    try{
      const t=new Image(); t.src='logo_pdf.png';
      await new Promise(r=>{ t.onload=r; t.onerror=r; });
      if(t.complete&&t.naturalWidth) logoSrc='logo_pdf.png';
    }catch{}

    add(`
      <div style="display:flex;justify-content:space-between;align-items:flex-start;padding:18px 24px 0 24px;gap:16px;">
        ${logoSrc?`<img src="${logoSrc}" alt="Harmex" style="height:82px;object-fit:contain">`:'<div></div>'}
        <div style="text-align:right; font-size:12px; line-height:1.5;">
          <strong style="font-size:14px">Harmex</strong><br>
          사업자등록번호: 749-11-02981<br>
          Tel: +82 10 3056 0903<br>
          Email: annamoloz95@gmail.com<br>
          Address: 201, 42 Hambak-ro84beon-gil,<br>
          Yeonsu-dong, Yeonsu-gu, Incheon, South Korea<br>
          Director: Molozhavaia Anna
        </div>
      </div>
      <div style="text-align:center; font-weight:700; font-size:20px; margin:16px 24px 4px;">Отчёт по расчёту автомобиля из Кореи</div>
      <div style="text-align:center; font-size:12px; color:#222; margin-bottom:10px;">Дата: ${new Date().toLocaleDateString('ru-RU')}</div>
      <div style="height:1px;background:#000;margin:6px 24px 12px;"></div>
    `);

    add(`
      <div style="margin:0 24px 10px;">
        <div style="font-weight:700; margin:6px 0;">Курсы валют</div>
        <table style="width:100%; border-collapse:collapse; font-size:14px;">
          <thead>
            <tr>
              <th style="text-align:left; border-bottom:2px solid #000; padding:8px 6px;">Пара</th>
              <th style="text-align:right; border-bottom:2px solid #000; padding:8px 6px;">Курс</th>
            </tr>
          </thead>
          <tbody>
            <tr><td style="padding:8px 6px; border-bottom:1px solid #e5e7eb;">1 USDT → ₽</td>
                <td style="padding:8px 6px; text-align:right; border-bottom:1px solid #e5e7eb;">${fmt(rubUsdt,4)} ₽</td></tr>
            <tr><td style="padding:8px 6px; border-bottom:1px solid #e5e7eb;">1 USDT → ₩</td>
                <td style="padding:8px 6px; text-align:right; border-bottom:1px solid #e5e7eb;">${fmt(usdtKrw,2)} ₩</td></tr>
            <tr><td style="padding:8px 6px; border-bottom:1px solid #e5e7eb;">1 EUR → ₽ (ЦБ)</td>
                <td style="padding:8px 6px; text-align:right; border-bottom:1px solid #e5e7eb;">${fmt(eurRub,6)} ₽</td></tr>
            <tr><td style="padding:8px 6px;">1 KRW → ₽ (ЦБ)</td>
                <td style="padding:8px 6px; text-align:right;">${fmt(krwRub,6)} ₽</td></tr>
          </tbody>
        </table>
      </div>
    `);

    add(`
      <div style="margin:10px 24px;">
        <div style="font-weight:700; margin:6px 0;">Корея</div>
        <table style="width:100%; border-collapse:collapse; font-size:14px;">
          <tbody>
            <tr><td style="padding:8px 6px; border-bottom:1px solid #e5e7eb;">Цена авто (KRW)</td>
                <td style="padding:8px 6px; text-align:right; border-bottom:1px solid #e5e7eb;">${fmt(priceKrw)} ₩</td></tr>
            <tr><td style="padding:8px 6px; border-bottom:2px solid #000;">Расходы в Корее: автоподбор, комиссия дилера, экспортные документы, автовоз до порта, фрахт до Владивостока (KRW)</td>
                <td style="padding:8px 6px; text-align:right; border-bottom:2px solid #000;">${fmt(expensesKrw)} ₩</td></tr>
            <tr><td style="padding:8px 6px;"><strong>Сколько рублей подготовить для перевода USDT</strong></td>
                <td style="padding:8px 6px; text-align:right;"><strong>${fmt((priceKrw+expensesKrw)/(usdtKrw||1)*rubUsdt)} ₽</strong></td></tr>
          </tbody>
        </table>
      </div>
    `);

    add(`
      <div style="margin:10px 24px;">
        <div style="font-weight:700; margin:6px 0;">Россия</div>
        <table style="width:100%; border-collapse:collapse; font-size:14px;">
          <tbody>
            <tr><td style="padding:8px 6px; border-bottom:1px solid #e5e7eb;">Пошлина</td>
                <td style="padding:8px 6px; text-align:right; border-bottom:1px solid #e5e7eb;">${fmt(autoDuty)} ₽</td></tr>
            <tr><td style="padding:8px 6px; border-bottom:1px solid #e5e7eb;">Таможенный сбор</td>
                <td style="padding:8px 6px; text-align:right; border-bottom:1px solid #e5e7eb;">${fmt(autoCustomsFee)} ₽</td></tr>
            <tr><td style="padding:8px 6px; border-bottom:2px solid #000;">Утилизационный сбор</td>
                <td style="padding:8px 6px; text-align:right; border-bottom:2px солид #000;">${fmt(autoUtil)} ₽</td></tr>
            <tr><td style="padding:8px 6px;"><strong>Итого «Пошлина и сборы»</strong></td>
                <td style="padding:8px 6px; text-align:right;"><strong>${fmt(autoTotal)} ₽</strong></td></tr>
            <tr><td style="padding:8px 6px;">Цена авто с пошлиной и сборами (RUB)</td>
                <td style="padding:8px 6px; text-align:right;">${fmt(priceWithDutyRub)} ₽</td></tr>
            <tr><td style="padding:8px 6px;">Услуги брокера, СБКТС, ЭПТС, РПП и СВХ, экспертиза</td>
                <td style="padding:8px 6px; text-align:right;">${fmt(brokerRub)} ₽</td></tr>
            <tr><td style="padding:8px 6px; border-bottom:2px solid #000;">Доставка по России</td>
                <td style="padding:8px 6px; text-align:right; border-bottom:2px solid #000;">${fmt(deliveryRub)} ₽</td></tr>
            <tr><td style="padding:8px 6px;"><strong>Итого по России</strong></td>
                <td style="padding:8px 6px; text-align:right;"><strong>${fmt(russiaSubtotal)} ₽</strong></td></tr>
          </tbody>
        </table>
      </div>
    `);

    if (insuranceOn){
      add(`
        <div style="margin:10px 24px;">
          <div style="font-weight:700; margin:6px 0;">Дополнительно</div>
          <table style="width:100%; border-collapse:collapse; font-size:14px;">
            <tbody>
              <tr><td style="padding:8px 6px; border-bottom:2px solid #000;">Страховка (0,3%)</td>
                  <td style="padding:8px 6px; text-align:right; border-bottom:2px solid #000;">${fmt(insuranceRub)} ₽</td></tr>
            </tbody>
          </table>
        </div>
      `);
    }

    add(`
      <div style="margin:12px 24px 0;">
        <div style="font-weight:700; margin:6px 0;">Итог</div>
        <table style="width:100%; border-collapse:collapse; font-size:15px;">
          <tbody>
            <tr>
              <td style="padding:10px 6px;"><strong>ПОД КЛЮЧ</strong></td>
              <td style="padding:10px 6px; text-align:right;"><strong>${fmt(finalRub)} ₽</strong></td>
            </tr>
          </tbody>
        </table>
        <div style="font-size:11px; color:#555; margin:12px 24px 18px;">Источник расчёта: https://grizar94-hash.github.io/AutoCalc/</div>
      </div>
    `);

    document.body.appendChild(page);

    const canvas = await html2canvas(page, { scale:2, useCORS:true });
    const imgData = canvas.toDataURL('image/png');

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p','pt','a4');

    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();

    const imgW = canvas.width;
    const imgH = canvas.height;

    const scale = Math.min(pageW / imgW, pageH / imgH);
    const drawW = imgW * scale;
    const drawH = imgH * scale;
    const x = (pageW - drawW) / 2;
    const y = (pageH - drawH) / 2;

    pdf.addImage(imgData, 'PNG', x, y, drawW, drawH);
    pdf.save('AutoCalc_Report.pdf');

    document.body.removeChild(page);
  }catch(err){
    alert('Не удалось сформировать PDF. Открой страницу через HTTPS (например, GitHub Pages) и попробуй снова.');
    console.error(err);
  }
}

/* ===== init ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  // тема
  const root = document.documentElement;
  const themeSelect = $('themeSelect');
  const savedTheme = localStorage.getItem('theme') || 'system';
  root.setAttribute('data-theme', savedTheme);
  themeSelect.value = savedTheme;
  themeSelect.addEventListener('change', ()=>{
    root.setAttribute('data-theme', themeSelect.value);
    localStorage.setItem('theme', themeSelect.value);
  });

  // фон
  const bgSelect = $('bgSelect');
  const savedBg = localStorage.getItem('bg') || 'off';
  document.body.classList.toggle('bg-bmw', savedBg==='bmw');
  bgSelect.value = savedBg;
  bgSelect.addEventListener('change', ()=>{
    const on = bgSelect.value==='bmw';
    document.body.classList.toggle('bg-bmw', on);
    localStorage.setItem('bg', on?'bmw':'off');
  });

  // автокурсы
  fetchUsdt(); fetchCbr();

  // кнопки
  const btn=$('insuranceBtn'), chk=$('insuranceCheck');
  btn.addEventListener('click', ()=>{
    btn.classList.toggle('active');
    const on = btn.classList.contains('active');
    btn.textContent = `Страховка 0,3%: ${on?'вкл':'выкл'}`;
    chk.checked = on;
  });

  $('calcBtn').addEventListener('click', calculate);
  $('clearBtn').addEventListener('click', ()=>{
    document.querySelectorAll('input').forEach(i=>{
      if(i.type!=='radio' && i.type!=='checkbox') i.value='';
    });
    $('insuranceCheck').checked=false;
    btn.classList.remove('active'); btn.textContent='Страховка 0,3%: выкл';
    $('result').innerHTML='';
    recompute();
  });
  $('pdfBtn').addEventListener('click', downloadPDF);

  // живые пробелы в нужных инпутах
  ['rubUsdt','usdtKrw','priceKrw','expensesKrw','engineCc','motorKw','brokerRub','deliveryRub']
    .forEach(id=> liveIntegerSpaces($(id)));

  // пересчёт на ввод
  document.querySelectorAll('input').forEach(el=>{
    if(el.type!=='radio' && el.type!=='checkbox') el.addEventListener('input', recompute);
  });
  document.querySelectorAll('input[name="importer"],input[name="eng"],input[name="age"],input[name="age_ev"]')
    .forEach(el=>el.addEventListener('change', ()=>{ toggleEV(); recompute(); }));

  toggleEV(); recompute();
});
</script>
</body>
</html>
