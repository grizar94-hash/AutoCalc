<!DOCTYPE html>
<html lang="ru" data-theme="system" data-bg="off">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Калькулятор авто из Кореи</title>

<link rel="icon" href="icon.png" type="image/png" />
<link rel="apple-touch-icon" href="icon.png" />
<link rel="manifest" href="manifest.json" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
  /* ===== ТЕМЫ ===== */
  :root{
    --accent:#0a66c2;
    --bg:#f5f6f8;
    --panel:#ffffff;
    --text:#1a1a1a;
    --muted:#6b7280;
    --border:#e5e7eb;
    --radius:10px;
    --shadow:0 2px 6px rgba(0,0,0,.06);
    --btn:#e5e7eb; --btn-text:#1a1a1a; --btn-hover:#d4d6db;
    --bg-img-opacity:.15;
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg:#0e1116; --panel:#12161d; --text:#e5e7eb; --muted:#9aa3af; --border:#232833; --shadow:none;
      --btn:#2a2f3a; --btn-text:#e5e7eb; --btn-hover:#3a4150;
      --bg-img-opacity:.18;
    }
  }
  [data-theme="light"]{
    --bg:#f5f6f8; --panel:#fff; --text:#1a1a1a; --muted:#6b7280; --border:#e5e7eb; --shadow:0 2px 6px rgba(0,0,0,.06);
    --btn:#e5e7eb; --btn-text:#1a1a1a; --btn-hover:#d4d6db; --bg-img-opacity:.15;
  }
  [data-theme="dark"]{
    --bg:#0e1116; --panel:#12161d; --text:#e5e7eb; --muted:#9aa3af; --border:#232833; --shadow:none;
    --btn:#2a2f3a; --btn-text:#e5e7eb; --btn-hover:#3a4150; --bg-img-opacity:.18;
  }

  /* ===== БАЗА ===== */
  *{ box-sizing:border-box }
  html,body{ height:100% }
  html{
    background:var(--bg);
    overscroll-behavior: none; /* убираем синий фон iOS при резиновом скролле */
  }
  body{
    font-family:'Inter','Roboto','Segoe UI',Arial,sans-serif;
    color:var(--text);
    margin:0; padding:20px; position:relative;
    background:transparent; /* фон переносим на html::before */
  }

  /* Фон — исправленный селектор */
  html::before{
    content:""; position:fixed; inset:0; pointer-events:none; z-index:-1;
    opacity:var(--bg-img-opacity); filter:grayscale(100%);
    background-position:center; background-size:cover; background-attachment:fixed;
    display:none;
  }
  html[data-bg="bmw"]::before{ display:block; background-image:url('bg_bmw.jpg'); }
  @supports (-webkit-touch-callout: none){
    html[data-bg="bmw"]::before{ background-attachment:scroll; }
  }

  .wrap{ max-width:820px; margin:0 auto; position:relative; z-index:1; }
  header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px; flex-wrap:wrap; }
  h1{ font-size:20px; margin:0; color:var(--accent); font-weight:700; }

  .switchers{ display:flex; gap:10px; flex-wrap:wrap; }
  .switchers .group{ display:flex; gap:6px; align-items:center; font-size:12px; color:var(--muted); }
  .switchers select{
    padding:8px 10px; border:1px solid var(--border); border-radius:8px; background:var(--panel); color:var(--text);
  }

  .section{
    background:var(--panel); border:1px solid var(--border);
    border-radius:var(--radius); padding:20px; margin-bottom:20px;
    box-shadow:var(--shadow);
  }
  .section h3{ margin:0 0 12px; font-size:18px; font-weight:600; }

  label{ display:block; margin-top:12px; font-weight:500; font-size:14px; }
  input, select{
    width:100%; padding:10px 12px;
    border:1px solid var(--border); border-radius:var(--radius);
    font-size:15px; margin-top:6px; background:var(--panel); color:var(--text);
  }
  input:focus, select:focus{ outline:none; border-color:var(--accent); box-shadow:0 0 0 1px var(--accent); }

  .row{ display:flex; gap:14px; flex-wrap:wrap; }
  .row>div{ flex:1 1 220px; }
  .subpanel{
    margin-top:14px; border:1px solid var(--border); border-radius:var(--radius);
    padding:14px; background:color-mix(in hsl, var(--panel), transparent 0%);
  }
  .subpanel h4{ margin:0 0 10px; font-size:15px; font-weight:600; }
  .grid{ display:grid; grid-template-columns:1fr auto; gap:8px 10px; align-items:center }
  .note{ font-size:12px; color:var(--muted); margin-top:4px }
  .muted{ color:var(--muted); font-size:13px }

  .radio-line{ display:flex; gap:10px; flex-wrap:wrap; margin-top:6px }
  .radio-line label{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px; border:1px solid var(--border); border-radius:999px;
    font-size:14px; cursor:pointer; background:var(--panel); white-space:nowrap;
    transition:background .15s,border-color .15s, box-shadow .15s;
  }
  .radio-line input{ appearance:none; width:14px; height:14px; border-radius:50%; border:2px solid var(--muted); display:inline-block; position:relative; }
  .radio-line input:checked{ border-color:#3b82f6; box-shadow:inset 0 0 0 3px var(--panel), 0 0 0 3px #3b82f6; }
  .radio-line input:focus-visible{ outline:2px solid var(--accent); }
  .radio-line input + span{ font-weight:500 }
  .radio-line input:checked + span{ font-weight:600 }

  button, .toggle-btn{
    width:100%; padding:14px; margin-top:14px;
    font-size:16px; font-weight:600;
    border:none; border-radius:var(--radius);
    cursor:pointer; background:var(--btn); color:var(--btn-text);
    transition:.2s; box-shadow:var(--shadow);
  }
  button:hover{ background:var(--btn-hover) }

  .result{
    margin-top:20px; padding:20px;
    background:var(--panel); border:1px solid var(--border);
    border-radius:var(--radius); font-size:16px;
    box-shadow:var(--shadow);
  }
  .result p{ margin:10px 0; font-weight:600 }
  hr{ border:0; border-top:1px solid var(--border); margin:12px 0 }
  .auto-output{ background:var(--panel) }
</style>
</head>
<body>
<main class="wrap">
  <header>
    <h1>Калькулятор доставки авто из Кореи</h1>

    <div class="switchers">
      <div class="group">
        Тема:
        <select id="themeSelect" aria-label="Переключатель темы">
          <option value="system" selected>Система</option>
          <option value="light">Светлая</option>
          <option value="dark">Тёмная</option>
        </select>
      </div>
      <div class="group">
        Фон:
        <select id="bgSelect" aria-label="Переключатель фона">
          <option value="off" selected>Выкл</option>
          <option value="bmw">BMW</option>
        </select>
      </div>
    </div>
  </header>

  <!-- 1) КУРСЫ ВАЛЮТ -->
  <div class="section" id="blockCurrency">
    <h3>Курсы валют</h3>

    <div class="row">
      <div>
        <label>USDT → ₽:
          <input type="text" inputmode="decimal" id="rubUsdt" placeholder="введите или авто">
        </label>
        <div class="note" id="usdtSrc">Источник: —</div>
      </div>

      <div>
        <label>USDT → ₩:
          <input type="text" inputmode="decimal" id="usdtKrw" placeholder="введите или авто">
        </label>
        <div class="note" id="usdtSrc2">Источник: —</div>
      </div>
    </div>

    <div class="subpanel">
      <div class="grid">
        <div class="muted">Курс EUR → ₽ (ЦБ)</div>
        <input class="auto-output" id="eurRub" placeholder="авто" readonly>
        <div class="muted">Курс KRW → ₽ (ЦБ)</div>
        <input class="auto-output" id="krwRub" placeholder="авто" readonly>
      </div>
      <div class="note" id="cbrSrc">Курсы ЦБ РФ на —</div>
    </div>
  </div>

  <!-- 2) КОРЕЯ -->
  <div class="section" id="blockKorea">
    <h3>Корея</h3>
    <label>Цена авто (₩): <input type="text" inputmode="numeric" id="priceKrw" placeholder=""></label>
    <label>Расходы в Корее (₩): <input type="text" inputmode="numeric" id="expensesKrw" placeholder=""></label>
  </div>

  <!-- 3) РОССИЯ -->
  <div class="section" id="blockRussia">
    <h3>Россия</h3>

    <div class="subpanel" id="autoCustoms">
      <h4>Авторасчёт пошлины и сборов</h4>

      <div class="row">
        <div>
          <div class="muted">Тип ввозящего</div>
          <div class="radio-line">
            <label><input type="radio" name="importer" value="individual" checked> <span>Физлицо</span></label>
            <label><input type="radio" name="importer" value="business"> <span>Юрлицо / ИП</span></label>
          </div>
        </div>
        <div>
          <div class="muted">Тип двигателя</div>
          <div class="radio-line">
            <label><input type="radio" name="eng" value="ice" checked> <span>ДВС</span></label>
            <label><input type="radio" name="eng" value="ev"> <span>Электро</span></label>
          </div>
        </div>
      </div>

      <div class="row" id="paramsICE">
        <div>
          <label>Объём двигателя (см³): <input type="text" inputmode="numeric" id="engineCc" placeholder=""></label>
        </div>
        <div>
          <div class="muted">Возраст</div>
          <div class="radio-line">
            <label><input type="radio" name="age" value="<3"> <span>Младше 3</span></label>
            <label><input type="radio" name="age" value="3-5" checked> <span>3–5</span></label>
            <label><input type="radio" name="age" value=">5"> <span>Старше 5</span></label>
          </div>
        </div>
      </div>

      <div class="row" id="paramsEV" style="display:none">
        <div><label>Мощность (кВт): <input type="text" inputmode="numeric" id="motorKw" placeholder=""></label></div>
        <div>
          <div class="muted">Возраст</div>
          <div class="radio-line">
            <label><input type="radio" name="age_ev" value="<3" checked> <span>Младше 3</span></label>
            <label><input type="radio" name="age_ev" value=">=3"> <span>3 и старше</span></label>
          </div>
        </div>
      </div>

      <input type="hidden" id="__tsRubHidden">

      <div class="subpanel">
        <div class="grid">
          <div>Цена авто с пошлиной и сборами (₽)</div>
          <input class="auto-output" id="priceWithDutyRub" readonly>
        </div>
      </div>

      <div class="subpanel">
        <div class="grid">
          <div>Пошлина (₽)</div>                              <input class="auto-output" id="autoDuty" readonly>
          <div>Таможенный сбор (₽)</div>                      <input class="auto-output" id="autoCustomsFee" readonly>
          <div>Утилизационный сбор (₽)</div>                  <input class="auto-output" id="autoUtil" readonly>
          <div><strong>Итого «Пошлина и сборы» (₽)</strong></div> <input class="auto-output" id="autoTotalCustoms" readonly>
        </div>
      </div>
    </div>

    <label>Услуги в России (₽): <input type="text" inputmode="numeric" id="brokerRub" placeholder=""></label>
    <label>Доставка по России (₽): <input type="text" inputmode="numeric" id="deliveryRub" placeholder=""></label>
  </div>

  <button id="insuranceBtn" type="button" class="toggle-btn">Страховка 0,3%: выкл</button>
  <input type="checkbox" id="insuranceCheck" hidden>

  <button id="calcBtn">Рассчитать</button>
  <button class="clear" id="clearBtn">Очистить поля</button>

  <div class="result" id="result"></div>

  <button class="pdf" id="pdfBtn">Скачать PDF-отчёт</button>
</main>

<script>
/* ===== ставки (обновлённые) ===== */
const DUTY_INDIV = {
  "<3":[
    {min:0,max:1000,adval:0.48,spec:3.5},{min:1000,max:1500,adval:0.48,spec:3.5},
    {min:1500,max:1800,adval:0.48,spec:3.5},{min:1800,max:2000,adval:0.48,spec:3.5},
    {min:2000,max:3000,adval:0.15,spec:2.5},{min:3000,max:3500,adval:0.15,spec:2.7},{min:3500,max:1e9,adval:0.20,spec:3.0}
  ],
  "3-5":[
    {min:0,max:1000,adval:null,spec:1.5},{min:1000,max:1500,adval:null,spec:1.7},
    {min:1500,max:1800,adval:null,spec:2.5},{min:1800,max:2300,adval:null,spec:2.7},
    {min:2300,max:3000,adval:null,spec:3.0},{min:3000,max:3500,adval:null,spec:3.6},{min:3500,max:1e9,adval:null,spec:5.7}
  ],
  ">5":[
    {min:0,max:1000,adval:null,spec:3.0},{min:1000,max:1500,adval:null,spec:3.2},
    {min:1500,max:1800,adval:null,spec:3.5},{min:1800,max:2300,adval:null,spec:4.8},
    {min:2300,max:3000,adval:null,spec:5.0},{min:3000,max:3500,adval:null,spec:5.7},{min:3500,max:1e9,adval:null,spec:7.5}
  ]
};
const DUTY_BIZ = DUTY_INDIV;

/* ===== Таможенный сбор (01.01.2025) ===== */
const CUSTOMS_FEE = [
  {max:200000,  fee:1067},
  {max:450000,  fee:2134},
  {max:1200000, fee:4269},
  {max:2700000, fee:11746},
  {max:4200000, fee:16524},
  {max:5500000, fee:21344},
  {max:7000000, fee:27540},
  {max:1e12,    fee:30000}
];

/* ===== утилиты ===== */
const $=id=>document.getElementById(id);
const stripToDigits = v => String(v ?? '').replace(/\D/g,'');
const rawNumber = v => String(v ?? '').replace(/[^\d.,-]/g,'').replace(/\s/g,'').replace(',','.');
const num = v => (parseFloat(rawNumber(v))||0);
const fmtSpaces = (n, frac=0) => {
  if(!isFinite(n)) return '';
  const opts={useGrouping:true, minimumFractionDigits:frac, maximumFractionDigits:frac};
  return Number(n).toLocaleString('ru-RU', opts).replace(/\u00A0/g,' ');
};

function liveIntegerSpaces(el){
  el.addEventListener('input', ()=>{
    const digits = stripToDigits(el.value);
    el.value = digits ? fmtSpaces(digits) : '';
  });
  el.addEventListener('focus', ()=> el.setSelectionRange(el.value.length, el.value.length));
}

/* — радиоблоки / типы — */
function pickRow(tbl,age,cc){ return tbl[age].find(r=>cc>r.min && cc<=r.max); }
function dutyICE({table,age,cc,ts,eurRub}){
  const r=pickRow(table,age,cc);
  if(!r) return 0; /* защита при пустом объёме */
  const ad=r.adval?ts*r.adval:0; const sp=r.spec?cc*r.spec*eurRub:0; return Math.max(ad,sp);
}
function dutyEV(ts){ return ts*0.15; }
function customsFee(ts){ return CUSTOMS_FEE.find(b=>ts<=b.max).fee; }

/* === Утильсбор 2025 ===
   individual (льготный): 3400 / 5200
   business/ИП: фиксированные суммы по таблице (ДВС и ЭВ) */
function utilFee({importer,isEV,age,cc,kw}){
  if (importer==='individual'){
    // льготный утильсбор (по ПТД)
    return (age === '<3') ? 3400 : 5200;
  }

  // Юрлица/ИП
  const older = (age === '>=3' || age === '>5'); // для ДВС берём колонку "старше 3 лет"
  if (isEV){
    return older ? 1174000 : 667400;
  }
  const v = Number(cc)||0;
  if (v<=1000)  return older ? 460000  : 180200;
  if (v<=2000)  return older ? 1174000 : 667400;
  if (v<=3000)  return older ? 2839400 : 1875400;
  if (v<=3500)  return older ? 3296800 : 2153400;
  return older ? 3604800 : 2742200;
}

/* ===== курсы ===== */
async function fetchCbr(){
  try{
    const r = await fetch('https://www.cbr-xml-daily.ru/daily_json.js', {cache:'no-store'});
    const d = await r.json();
    const EUR = d.Valute.EUR.Value / d.Valute.EUR.Nominal;
    const KRW = d.Valute.KRW.Value / d.Valute.KRW.Nominal;
    $('eurRub').value = fmtSpaces(EUR,6);
    $('krwRub').value = fmtSpaces(KRW,6);
    const dt = new Date(d.Date);
    $('cbrSrc').textContent = `Курсы ЦБ РФ на ${dt.toLocaleDateString('ru-RU')}`;
  }catch(e){ $('cbrSrc').textContent='Курсы ЦБ РФ: ошибка загрузки'; }
}
async function fetchUsdt(){
  try{
    const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=tether&vs_currencies=rub,krw', {cache:'no-store'});
    const j = await r.json();
    $('rubUsdt').value = fmtSpaces(Number(j.tether.rub),4);
    $('usdtKrw').value = fmtSpaces(Number(j.tether.krw),2);
    const now = new Date().toLocaleString('ru-RU');
    $('usdtSrc').textContent  = `Источник: CoinGecko • ${now}`;
    $('usdtSrc2').textContent = `Источник: CoinGecko • ${now}`;
  }catch(e){
    $('usdtSrc').textContent='Источник: ошибка загрузки';
    $('usdtSrc2').textContent='Источник: ошибка загрузки';
  }
}

/* ===== управление UI ===== */
function engineType(){ return document.querySelector('input[name="eng"]:checked').value; }
function importer(){ return document.querySelector('input[name="importer"]:checked').value; }
function ageRaw(){
  return engineType()==='ev'
    ? document.querySelector('input[name="age_ev"]:checked').value
    : document.querySelector('input[name="age"]:checked').value;
}
function toggleEV(){
  const ev = engineType()==='ev';
  $('paramsICE').style.display = ev ? 'none' : 'flex';
  $('paramsEV').style.display  = ev ? 'flex' : 'none';
}

/* ===== пересчёт авторасчёта пошлин ===== */
function recompute(){
  const eur=num($('eurRub').value), krw=num($('krwRub').value);
  const priceKrw=num($('priceKrw').value), expKrw=num($('expensesKrw').value);
  const ts = (priceKrw + expKrw) * krw; $('__tsRubHidden').value=Math.round(ts);

  const imp=importer(), ev=engineType()==='ev', age=ageRaw();
  let duty=0, util=0;
  if(ev){
    duty = dutyEV(ts);
    const kw=num($('motorKw').value);
    util = utilFee({importer:imp,isEV:true,age,kw});
  }else{
    const cc=num($('engineCc').value);
    const table=(imp==='business')?DUTY_BIZ:DUTY_INDIV;
    duty = dutyICE({table,age,cc,ts,eurRub:eur});
    util = utilFee({importer:imp,isEV:false,age,cc});
  }
  const fee=customsFee(ts);
  const total=Math.round(duty+fee+util);

  $('autoDuty').value = fmtSpaces(duty);
  $('autoCustomsFee').value = fmtSpaces(fee);
  $('autoUtil').value = fmtSpaces(util);
  $('autoTotalCustoms').value = fmtSpaces(total);

  const carPriceRub = priceKrw * krw;
  $('priceWithDutyRub').value = fmtSpaces(Math.round(carPriceRub + total));
}

/* ===== основной расчёт ===== */
function calculate(){
  const rubUsdt=num($('rubUsdt').value), usdtKrw=num($('usdtKrw').value);
  const priceKrw=num($('priceKrw').value), expKrw=num($('expensesKrw').value);
  const autoTotal=num($('autoTotalCustoms').value), broker=num($('brokerRub').value), delivery=num($('deliveryRub').value);
  const insuranceOn=$('insuranceCheck').checked;

  const koreaKrw = priceKrw + expKrw;
  const rubNeeded = usdtKrw ? (koreaKrw/usdtKrw)*rubUsdt : 0;
  const russiaSubtotal = autoTotal + broker + delivery;
  const preFinal = rubNeeded + russiaSubtotal;
  const insurance = insuranceOn ? preFinal*0.003 : 0;
  const finalRub = preFinal + insurance;

  $('result').innerHTML = `
    <p>В Корее: ${fmtSpaces(Math.round(rubNeeded))} ₽</p>
    <p>В России: ${fmtSpaces(Math.round(russiaSubtotal))} ₽</p>
    ${insuranceOn ? `<p>Страховка: ${fmtSpaces(Math.round(insurance))} ₽</p>` : ''}
    <hr><p>Под ключ: <strong>${fmtSpaces(Math.round(finalRub))} ₽</strong></p>`;
}

/* ===== PDF ===== */
function fmt(n,d=0){ if(!isFinite(n)) return '—'; const v=d?Number(n).toFixed(d):Math.round(n); return fmtSpaces(Number(v), d); }
const nowrap = (val,sym) => `<span style="white-space:nowrap;">${fmt(val)} ${sym}</span>`;

async function downloadPDF(){
  try{
    const val = id => num($(id)?.value);
    const insuranceOn = $('insuranceCheck').checked;

    const priceKrw    = val('priceKrw');
    const expensesKrw = val('expensesKrw');
    const rubUsdt     = val('rubUsdt');
    const usdtKrw     = val('usdtKrw');
    const eurRub      = val('eurRub');
    const krwRub      = val('krwRub');

    const autoDuty    = val('autoDuty');
    const autoCustomsFee = val('autoCustomsFee');
    const autoUtil    = val('autoUtil');
    const autoTotal   = val('autoTotalCustoms');
    const priceWithDutyRub = val('priceWithDutyRub');

    const brokerRub   = val('brokerRub');
    const deliveryRub = val('deliveryRub');

    const koreaKrw        = priceKrw + expensesKrw;
    const rubNeeded       = usdtKrw ? (koreaKrw / usdtKrw) * rubUsdt : 0;
    const russiaSubtotal  = autoTotal + brokerRub + deliveryRub;
    const preFinal        = rubNeeded + russiaSubtotal;
    const insuranceRub    = insuranceOn ? preFinal * 0.003 : 0;
    const finalRub        = preFinal + insuranceRub;

    const page = document.createElement('div');
    page.style.cssText = `
      position:fixed; left:-99999px; top:0; width:794px;
      background:#fff; color:#000; font-family:-apple-system, system-ui, Segoe UI, Inter, Roboto, Arial, sans-serif;
    `;
    const add = html => { const d=document.createElement('div'); d.innerHTML=html; page.appendChild(d); };

    add('<div style="height:8px;background:#111;width:100%"></div>');

    let logoSrc='';
    try{
      const test=new Image(); test.src='logo_pdf.png';
      await new Promise(res=>{ test.onload=res; test.onerror=res; });
      if (test.complete && test.naturalWidth) logoSrc='logo_pdf.png';
    }catch{}

    add(`
      <div style="display:flex;justify-content:space-between;align-items:flex-start;padding:18px 24px 0 24px;gap:16px;">
        ${logoSrc?`<img src="${logoSrc}" alt="Harmex" style="height:82px;object-fit:contain">`:'<div></div>'}
        <div style="text-align:right; font-size:12px; line-height:1.5;">
          <strong style="font-size:14px">Harmex</strong><br>
          사업자등록번호: 749-11-02981<br>
          Tel: +82 10 3056 0903<br>
          Email: annamoloz95@gmail.com<br>
          Address: 201, 42 Hambak-ro84beon-gil,<br>
          Yeonsu-dong, Yeonsu-gu, Incheon, South Korea<br>
          Director: Molozhavaia Anna
        </div>
      </div>
      <div style="text-align:center; font-weight:700; font-size:20px; margin:16px 24px 4px;">Отчёт по расчёту автомобиля из Кореи</div>
      <div style="text-align:center; font-size:12px; color:#222; margin-bottom:10px;">Дата: ${new Date().toLocaleDateString('ru-RU')}</div>
      <div style="height:1px;background:#000;margin:6px 24px 12px;"></div>
    `);

    const tblHead = `style="text-align:left;border-bottom:2px solid #000;padding:8px 6px"`;
    const tdL = `style="padding:8px 6px;border-bottom:1px solid #e5e7eb;text-align:left"`;
    const tdR = `style="padding:8px 6px;border-bottom:1px solid #e5e7eb;text-align:right"`;
    const tdRbold = `style="padding:8px 6px;text-align:right"`;
    const sep = `style="height:1px;background:#000;margin:6px 24px 12px;"`;

    /* Курсы */
    add(`
      <div style="margin:0 24px 10px;">
        <div style="font-weight:700; margin:6px 0;">Курсы валют</div>
        <table style="width:100%; border-collapse:collapse; font-size:14px;">
          <thead>
            <tr>
              <th ${tblHead}>Пара</th>
              <th ${tblHead.replace('left','right')}>Курс</th>
            </tr>
          </thead>
          <tbody>
            <tr><td ${tdL}>1 USDT → ₽</td><td ${tdR}>${nowrap(rubUsdt,'₽')}</td></tr>
            <tr><td ${tdL}>1 USDT → ₩</td><td ${tdR}>${nowrap(usdtKrw,'₩')}</td></tr>
            <tr><td ${tdL}>1 EUR → ₽ (ЦБ)</td><td ${tdR}>${nowrap(eurRub,'₽')}</td></tr>
            <tr><td ${tdL.replace('border-bottom:1px','border-bottom:0')} >1 KRW → ₽ (ЦБ)</td><td ${tdR.replace('border-bottom:1px','border-bottom:0')}>${nowrap(krwRub,'₽')}</td></tr>
          </tbody>
        </table>
      </div>
    `);

    /* Корея */
    add(`
      <div style="margin:10px 24px;">
        <div style="font-weight:700; margin:6px 0;">Корея</div>
        <table style="width:100%; border-collapse:collapse; font-size:14px;">
          <tbody>
            <tr><td ${tdL}>Цена авто (KRW)</td><td ${tdR}>${nowrap(priceKrw,'₩')}</td></tr>
            <tr><td ${tdL.replace('1px solid #e5e7eb','2px solid #000')}>Расходы в Корее: автоподбор, комиссия дилера, экспортные документы, автовоз до порта, фрахт до Владивостока</td>
                <td ${tdR.replace('1px solid #e5e7eb','2px solid #000')}>${nowrap(expensesKrw,'₩')}</td></tr>
            <tr><td ${tdL.replace('border-bottom:1px solid #e5e7eb;','border-bottom:0;')}><strong>Сколько рублей подготовить для перевода USDT</strong></td>
                <td ${tdRbold}><strong>${nowrap((priceKrw+expensesKrw)/(usdtKrw||1)*rubUsdt,'₽')}</strong></td></tr>
          </tbody>
        </table>
      </div>
    `);

    /* Россия */
    add(`
      <div style="margin:10px 24px;">
        <div style="font-weight:700; margin:6px 0;">Россия</div>
        <table style="width:100%; border-collapse:collapse; font-size:14px;">
          <tbody>
            <tr><td ${tdL}>Пошлина</td><td ${tdR}>${nowrap(autoDuty,'₽')}</td></tr>
            <tr><td ${tdL}>Таможенный сбор</td><td ${tdR}>${nowrap(autoCustomsFee,'₽')}</td></tr>
            <tr><td ${tdL.replace('1px solid #e5e7eb','2px solid #000')}>Утилизационный сбор</td>
                <td ${tdR.replace('1px solid #e5e7eb','2px solid #000')}>${nowrap(autoUtil,'₽')}</td></tr>
            <tr><td ${tdL}>Итого «Пошлина и сборы»</td><td ${tdR}>${nowrap(autoTotal,'₽')}</td></tr>
            <tr><td ${tdL}>Цена авто с пошлиной и сборами (RUB)</td><td ${tdR}>${nowrap(priceWithDutyRub,'₽')}</td></tr>
            <tr><td ${tdL.replace('border-bottom:1px solid #e5e7eb;','border-bottom:0;')}>Услуги брокера, СБКТС, ЭПТС, РПП и СВХ, экспертиза</td>
                <td ${tdRbold}>${nowrap(brokerRub,'₽')}</td></tr>
            <tr><td ${tdL.replace('1px solid #e5e7eb','2px solid #000')}>Доставка по России</td>
                <td ${tdR.replace('1px solid #e5e7eb','2px solid #000')}>${nowrap(deliveryRub,'₽')}</td></tr>
            <tr><td ${tdL.replace('border-bottom:1px solid #e5e7eb;','border-bottom:0;')}><strong>Итого по России</strong></td>
                <td ${tdRbold}><strong>${nowrap(russiaSubtotal,'₽')}</strong></td></tr>
          </tbody>
        </table>
      </div>
    `);

    if (insuranceOn){
      add(`
        <div style="margin:10px 24px;">
          <div style="font-weight:700; margin:6px 0;">Дополнительно</div>
          <table style="width:100%; border-collapse:collapse; font-size:14px;">
            <tbody>
              <tr><td ${tdL.replace('1px solid #e5e7eb','2px solid #000')}>Страховка (0,3%)</td>
                  <td ${tdR.replace('1px solid #e5e7eb','2px solid #000')}>${nowrap(insuranceRub,'₽')}</td></tr>
            </tbody>
          </table>
        </div>
      `);
    }

    add(`
      <div style="margin:12px 24px 0;">
        <div style="font-weight:700; margin:6px 0;">Итог</div>
        <table style="width:100%; border-collapse:collapse; font-size:15px;">
          <tbody>
            <tr>
              <td style="padding:10px 6px;text-align:left;"><strong>ПОД КЛЮЧ</strong></td>
              <td style="padding:10px 6px;text-align:right;"><strong>${nowrap(finalRub,'₽')}</strong></td>
            </tr>
          </tbody>
        </table>
        <div style="font-size:11px; color:#555; margin:12px 24px 18px;">Источник расчёта: https://grizar94-hash.github.io/AutoCalc/</div>
      </div>
    `);

    document.body.appendChild(page);

    const canvas = await html2canvas(page, { scale:2, useCORS:true });
    const imgData = canvas.toDataURL('image/png');

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p','pt','a4');

    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();

    const imgW = canvas.width;
    const imgH = canvas.height;

    const scale = Math.min(pageW / imgW, pageH / imgH);
    const drawW = imgW * scale;
    const drawH = imgH * scale;
    const x = (pageW - drawW) / 2;
    const y = (pageH - drawH) / 2;

    pdf.addImage(imgData, 'PNG', x, y, drawW, drawH);
    pdf.save('AutoCalc_Report.pdf');

    document.body.removeChild(page);
  }catch(err){
    alert('Не удалось сформировать PDF. Открой через https (GitHub Pages) или обнови страницу.');
    console.error(err);
  }
}

/* ===== init ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  // Тема
  const root = document.documentElement;
  const savedTheme = localStorage.getItem('theme') || 'system';
  root.setAttribute('data-theme', savedTheme);
  themeSelect.value = savedTheme;
  themeSelect.addEventListener('change', ()=>{
    root.setAttribute('data-theme', themeSelect.value);
    localStorage.setItem('theme', themeSelect.value);
  });

  // Фон
  const savedBg = localStorage.getItem('bg') || 'off';
  document.documentElement.setAttribute('data-bg', savedBg);
  bgSelect.value = savedBg;
  bgSelect.addEventListener('change', ()=>{
    document.documentElement.setAttribute('data-bg', bgSelect.value);
    localStorage.setItem('bg', bgSelect.value);
  });

  // Автокурсы
  fetchUsdt(); fetchCbr();

  // Кнопки
  insuranceBtn.addEventListener('click', ()=>{
    insuranceBtn.classList.toggle('active');
    const on = insuranceBtn.classList.contains('active');
    insuranceBtn.textContent = `Страховка 0,3%: ${on?'вкл':'выкл'}`;
    insuranceCheck.checked = on;
  });
  calcBtn.addEventListener('click', calculate);
  clearBtn.addEventListener('click', ()=>{
    document.querySelectorAll('input').forEach(i=>{
      if(i.type!=='radio' && i.type!=='checkbox') i.value='';
    });
    insuranceCheck.checked=false;
    insuranceBtn.classList.remove('active'); insuranceBtn.textContent='Страховка 0,3%: выкл';
    result.innerHTML='';
    recompute();
  });
  pdfBtn.addEventListener('click', downloadPDF);

  /* Живое форматирование */
  ['priceKrw','expensesKrw','engineCc','motorKw','brokerRub','deliveryRub']
    .forEach(id => liveIntegerSpaces($(id)));

  /* пересчёт на ввод/переключение */
  document.querySelectorAll('input').forEach(el=>{
    if(el.type!=='radio' && el.type!=='checkbox') el.addEventListener('input', recompute);
  });
  document.querySelectorAll('input[name="importer"],input[name="eng"],input[name="age"],input[name="age_ev"]')
    .forEach(el=>el.addEventListener('change', ()=>{ toggleEV(); recompute(); }));

  toggleEV(); recompute();
});
</script>
</body>
</html>
